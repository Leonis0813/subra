if (ngx.var.cookie_algieba) then
  cookie = ngx.decode_base64(ngx.var.cookie_algieba)
  md, err = ngx.re.match(cookie, "^(.*):(.*)$")

  local mysql = require "resty.mysql"
  db, err = mysql:new()
  db:connect{
    host = "127.0.0.1",
    port = 3306,
    database = "algieba",
    user = "root",
    password = "<%= node[:mysql][:root_password] %>"
  }

  result, err, errno, sqlstate =
  db:query("SELECT COUNT(*) AS count FROM users WHERE user_id = '" .. md[1] .. "' AND password = '" .. md[2] .. "'")
  db:close()

  if(tonumber(result[1]["count"]) > 0) then
    ngx.header['Set-Cookie'] = 'algieba=' .. ngx.encode_base64(md[1] .. ":" .. md[2]) .. '; path=/'
  else
    return ngx.redirect("/login.html?redirect_uri=" .. ngx.escape_uri(ngx.var.redirect_uri))
  end
else
  return ngx.redirect("/login.html?redirect_uri=" .. ngx.escape_uri(ngx.var.redirect_uri))
end
