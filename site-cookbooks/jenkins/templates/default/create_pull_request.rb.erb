require 'json'
require 'net/https'

REPOSITORY = ARGV[0]
BASE_BRANCH = ARGV[1]
OWNER = '<%= Chef::EncryptedDataBagItem.load('github', 'account')['username'] %>'
GITHUB_URL = "https://api.github.com/repos/#{OWNER}/#{REPOSITORY}/pulls"
ACCESS_TOKEN = '<%= Chef::EncryptedDataBagItem.load('github', 'token')['public_repo'] %>'
UPDATE_GEM_TITLE = '<%= node[:jenkins][:github][:update_gem_title] %>'
UPDATE_GEM_BRANCH = '<%= node[:jenkins][:github][:update_gem_branch] %>'

parsed_url = URI.parse(GITHUB_URL)

begin
  response = Net::HTTP.start(parsed_url.host, parsed_url.port, :use_ssl => true) do |https|
    request = Net::HTTP::Post.new(parsed_url)
    request['Content-Type'] = 'application/json'
    request['Authorization'] = "token #{ACCESS_TOKEN}"
    body = {:title => UPDATE_GEM_TITLE, :base => BASE_BRANCH, :head => UPDATE_GEM_BRANCH}
    request.body = body.to_json
    https.request request
  end
rescue Exception => e
  exit 1
end

if response.code == '201'
  exit 0
else
  p response.body
  exit 1
end
